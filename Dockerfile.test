# Use Playwright's official image which includes all necessary browsers and dependencies
FROM mcr.microsoft.com/playwright:v1.40.0-jammy

# Install additional dependencies for Electron apps
RUN apt-get update && apt-get install -y \
    xvfb \
    libgtk-3-0 \
    libnotify4 \
    libnss3 \
    libxss1 \
    libxtst6 \
    xdg-utils \
    libatspi2.0-0 \
    libdrm2 \
    libgbm1 \
    libxcb-dri3-0 \
    libappindicator3-1 \
    libsecret-1-0 \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /app

# Copy package files
COPY package*.json ./

# Install Node dependencies
RUN npm install

# Copy test files and automation setup
COPY playwright.config.ts ./
COPY tsconfig.json ./
COPY tests/ ./tests/
COPY test-automation/ ./test-automation/
COPY main.js manifest.json styles.css ./

# Set environment variables for headless Electron
ENV ELECTRON_DISABLE_SANDBOX=1
ENV DISPLAY=:99
ENV PLAYWRIGHT_BROWSERS_PATH=/ms-playwright

# Create directory for test results
RUN mkdir -p test-results

# Default command runs tests with xvfb
CMD ["sh", "-c", "Xvfb :99 -screen 0 1280x720x24 -ac & npx playwright test --reporter=list"]
